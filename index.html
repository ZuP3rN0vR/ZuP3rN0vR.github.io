<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ultimate Discord Webhook Sender</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --discord-dark: #36393f;
            --discord-darker: #2f3136;
            --discord-darkest: #202225;
            --discord-text: #dcddde;
            --discord-text-muted: #a3a6aa;
            --discord-primary: #5865f2;
            --discord-primary-hover: #4752c4;
            --discord-success: #3ba55c;
            --discord-danger: #ed4245;
            --discord-embed: #2b2d31;
            --discord-embed-border: #1e1f22;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Inter', sans-serif;
        }

        body {
            background-color: var(--discord-darkest);
            color: var(--discord-text);
            min-height: 100vh;
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            padding: 20px;
        }

        @media (max-width: 1200px) {
            body {
                grid-template-columns: 1fr;
            }
        }

        .panel {
            background-color: var(--discord-dark);
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
        }

        h1, h2, h3 {
            color: white;
            margin-bottom: 16px;
            font-weight: 600;
        }

        h1 {
            font-size: 24px;
            margin-bottom: 24px;
        }

        h2 {
            font-size: 18px;
            margin-top: 20px;
        }

        .form-group {
            margin-bottom: 16px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: var(--discord-text-muted);
            font-size: 14px;
        }

        input, textarea, select {
            width: 100%;
            padding: 12px;
            background-color: var(--discord-darker);
            border: 1px solid var(--discord-darkest);
            border-radius: 4px;
            color: var(--discord-text);
            font-size: 14px;
            transition: border-color 0.2s;
        }

        input:focus, textarea:focus, select:focus {
            outline: none;
            border-color: var(--discord-primary);
        }

        textarea {
            min-height: 100px;
            resize: vertical;
        }

        .checkbox-group {
            display: flex;
            align-items: center;
            margin-bottom: 12px;
        }

        .checkbox-group input {
            width: auto;
            margin-right: 10px;
        }

        .checkbox-group label {
            margin-bottom: 0;
        }

        .btn {
            padding: 12px 24px;
            border-radius: 4px;
            border: none;
            font-weight: 600;
            cursor: pointer;
            transition: background-color 0.2s;
            font-size: 14px;
        }

        .btn-primary {
            background-color: var(--discord-primary);
            color: white;
        }

        .btn-primary:hover {
            background-color: var(--discord-primary-hover);
        }

        .btn-danger {
            background-color: var(--discord-danger);
            color: white;
        }

        .btn-danger:hover {
            background-color: #d13235;
        }

        .btn-secondary {
            background-color: var(--discord-darker);
            color: var(--discord-text);
        }

        .btn-secondary:hover {
            background-color: #4e525a;
        }

        .flex-row {
            display: flex;
            gap: 10px;
        }

        .flex-row > * {
            flex: 1;
        }

        .color-picker {
            display: flex;
            align-items: center;
        }

        .color-picker input {
            flex: 1;
            padding: 8px;
        }

        .color-picker-preview {
            width: 30px;
            height: 30px;
            border-radius: 4px;
            margin-left: 10px;
            border: 1px solid var(--discord-darkest);
        }

        .field-array {
            margin-bottom: 16px;
        }

        .field-array-item {
            background-color: var(--discord-darker);
            padding: 12px;
            border-radius: 4px;
            margin-bottom: 10px;
            position: relative;
        }

        .remove-btn {
            position: absolute;
            top: 8px;
            right: 8px;
            background: none;
            border: none;
            color: var(--discord-danger);
            cursor: pointer;
            font-size: 16px;
        }

        .add-btn {
            background-color: var(--discord-darker);
            border: 1px dashed var(--discord-text-muted);
            color: var(--discord-text-muted);
            padding: 8px;
            border-radius: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s;
        }

        .add-btn:hover {
            border-color: var(--discord-text);
            color: var(--discord-text);
        }

        /* Discord Preview Styles */
        .discord-preview {
            background-color: var(--discord-dark);
            border-radius: 8px;
            padding: 16px;
            font-family: 'Inter', sans-serif;
        }

        .discord-message {
            display: flex;
            margin-bottom: 20px;
        }

        .discord-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            margin-right: 16px;
            background-color: #5865f2;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 18px;
        }

        .discord-message-content {
            flex: 1;
        }

        .discord-message-header {
            display: flex;
            align-items: center;
            margin-bottom: 4px;
        }

        .discord-username {
            font-weight: 600;
            color: white;
            margin-right: 8px;
        }

        .discord-bot-tag {
            background-color: var(--discord-primary);
            color: white;
            font-size: 10px;
            padding: 2px 4px;
            border-radius: 3px;
            font-weight: 600;
            margin-right: 8px;
        }

        .discord-timestamp {
            color: var(--discord-text-muted);
            font-size: 12px;
        }

        .discord-message-text {
            color: var(--discord-text);
            line-height: 1.4;
        }

        .discord-embed {
            background-color: var(--discord-embed);
            border-left: 4px solid var(--discord-embed-border);
            border-radius: 4px;
            padding: 12px;
            margin-top: 8px;
            display: flex;
            max-width: 520px;
        }

        .discord-embed-color {
            width: 4px;
            background-color: #5865f2;
            border-radius: 4px 0 0 4px;
            margin-right: 12px;
        }

        .discord-embed-content {
            flex: 1;
        }

        .discord-embed-header {
            margin-bottom: 8px;
        }

        .discord-embed-title {
            color: white;
            font-weight: 600;
            font-size: 16px;
            margin-bottom: 4px;
        }

        .discord-embed-description {
            color: var(--discord-text);
            font-size: 14px;
            line-height: 1.4;
            margin-bottom: 8px;
        }

        .discord-embed-fields {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
            margin-bottom: 8px;
        }

        .discord-embed-field {
            font-size: 14px;
        }

        .discord-embed-field.inline {
            grid-column: span 1;
        }

        .discord-embed-field.full {
            grid-column: span 2;
        }

        .discord-embed-field-title {
            color: white;
            font-weight: 600;
            margin-bottom: 4px;
        }

        .discord-embed-field-value {
            color: var(--discord-text);
        }

        .discord-embed-footer {
            display: flex;
            align-items: center;
            margin-top: 8px;
            font-size: 12px;
            color: var(--discord-text-muted);
        }

        .discord-embed-footer-icon {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            margin-right: 8px;
            background-color: #ccc;
        }

        .discord-embed-image {
            max-width: 100%;
            border-radius: 4px;
            margin-top: 8px;
        }

        .discord-embed-thumbnail {
            width: 80px;
            height: 80px;
            border-radius: 4px;
            margin-left: 16px;
            background-color: #ccc;
            object-fit: cover;
        }

        .hidden {
            display: none;
        }

        .tabs {
            display: flex;
            margin-bottom: 20px;
            border-bottom: 1px solid var(--discord-darker);
        }

        .tab {
            padding: 10px 20px;
            cursor: pointer;
            font-weight: 500;
            color: var(--discord-text-muted);
            border-bottom: 2px solid transparent;
            transition: all 0.2s;
        }

        .tab.active {
            color: white;
            border-bottom-color: var(--discord-primary);
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .status {
            padding: 12px;
            border-radius: 4px;
            margin-top: 16px;
            font-weight: 500;
            display: none;
        }

        .status.success {
            background-color: rgba(59, 165, 92, 0.2);
            color: var(--discord-success);
            display: block;
        }

        .status.error {
            background-color: rgba(237, 66, 69, 0.2);
            color: var(--discord-danger);
            display: block;
        }

        .file-input-container {
            position: relative;
            margin-bottom: 16px;
        }

        .file-input-label {
            display: block;
            padding: 12px;
            background-color: var(--discord-darker);
            border: 1px dashed var(--discord-text-muted);
            border-radius: 4px;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s;
        }

        .file-input-label:hover {
            border-color: var(--discord-text);
        }

        .file-input {
            position: absolute;
            width: 0.1px;
            height: 0.1px;
            opacity: 0;
            overflow: hidden;
            z-index: -1;
        }

        .file-preview {
            margin-top: 8px;
            font-size: 14px;
            color: var(--discord-text-muted);
        }

        .file-preview img {
            max-width: 100px;
            max-height: 100px;
            border-radius: 4px;
            margin-top: 8px;
        }

        .message-info {
            background-color: var(--discord-darker);
            padding: 12px;
            border-radius: 4px;
            margin-top: 16px;
            font-size: 14px;
        }

        .message-info p {
            margin-bottom: 8px;
        }

        .message-info strong {
            color: white;
        }

        .loading {
            display: inline-block;
            width: 16px;
            height: 16px;
            border: 2px solid rgba(255,255,255,.3);
            border-radius: 50%;
            border-top-color: #fff;
            animation: spin 1s ease-in-out infinite;
            margin-right: 8px;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* JSON Preview Styles */
        .json-preview {
            background-color: var(--discord-darker);
            border-radius: 4px;
            padding: 12px;
            font-family: monospace;
            font-size: 13px;
            max-height: 300px;
            overflow-y: auto;
            white-space: pre-wrap;
            margin-top: 16px;
            border: 1px solid var(--discord-darkest);
        }
        
        .json-preview-container {
            position: relative;
        }
        
        .copy-json-btn {
            position: absolute;
            top: 8px;
            right: 8px;
            background-color: var(--discord-primary);
            color: white;
            border: none;
            border-radius: 4px;
            padding: 4px 8px;
            font-size: 12px;
            cursor: pointer;
        }
        
        .copy-json-btn:hover {
            background-color: var(--discord-primary-hover);
        }
        
        .json-key {
            color: #f92672;
        }
        
        .json-string {
            color: #a6e22e;
        }
        
        .json-number {
            color: #ae81ff;
        }
        
        .json-boolean {
            color: #ae81ff;
        }
        
        .json-null {
            color: #ae81ff;
        }

        /* Avatar Preview Styles */
        .avatar-preview-container {
            display: flex;
            align-items: center;
            margin-top: 8px;
        }
        
        .avatar-preview {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            margin-right: 10px;
            object-fit: cover;
        }
        
        .user-lookup {
            display: flex;
            margin-top: 8px;
        }
        
        .user-lookup input {
            flex: 1;
            margin-right: 8px;
        }
        
        .user-lookup button {
            padding: 0 12px;
        }
        
        .avatar-loading {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background-color: var(--discord-darker);
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 10px;
        }
        
        .avatar-loading .loading {
            margin: 0;
            width: 20px;
            height: 20px;
        }
    </style>
</head>
<body>
    <div class="panel">
        <h1>Ultimate Discord Webhook Sender</h1>
        
        <div class="tabs">
            <div class="tab active" data-tab="basic">Basic</div>
            <div class="tab" data-tab="embed">Embed</div>
            <div class="tab" data-tab="advanced">Advanced</div>
        </div>
        
        <div class="tab-content active" id="basic-tab">
            <div class="form-group">
                <label for="webhook-url">Webhook URL</label>
                <input type="text" id="webhook-url" placeholder="https://discord.com/api/webhooks/...">
            </div>
            
            <div class="form-group">
                <label for="username">Username (override)</label>
                <input type="text" id="username" placeholder="Leave empty to use webhook default">
            </div>
            
            <div class="form-group">
                <label for="avatar-url">Avatar URL (override)</label>
                <input type="text" id="avatar-url" placeholder="Leave empty to use webhook default">
                <div class="avatar-preview-container">
                    <img id="avatar-preview" class="avatar-preview" style="display: none;">
                    <div id="avatar-loading" class="avatar-loading" style="display: none;">
                        <div class="loading"></div>
                    </div>
                    <span id="avatar-preview-text">No avatar selected</span>
                </div>
                <div class="user-lookup">
                    <input type="text" id="user-id-input" placeholder="Enter User ID to copy profile">
                    <button class="btn btn-secondary" id="fetch-user-btn">Fetch</button>
                </div>
            </div>
            
            <div class="form-group">
                <label for="content">Message Content</label>
                <textarea id="content" placeholder="Enter your message text here"></textarea>
            </div>
            
            <div class="file-input-container">
                <label for="file" class="file-input-label">Upload File Attachment</label>
                <input type="file" id="file" class="file-input">
                <div class="file-preview" id="file-preview"></div>
            </div>
            
            <div class="checkbox-group">
                <input type="checkbox" id="tts">
                <label for="tts">Enable Text-to-Speech (TTS)</label>
            </div>
        </div>
        
        <div class="tab-content" id="embed-tab">
            <div class="form-group">
                <label for="embed-title">Embed Title</label>
                <input type="text" id="embed-title" placeholder="Embed title">
            </div>
            
            <div class="form-group">
                <label for="embed-description">Embed Description</label>
                <textarea id="embed-description" placeholder="Embed description (supports markdown)"></textarea>
            </div>
            
            <div class="form-group">
                <label for="embed-url">Embed URL (title link)</label>
                <input type="text" id="embed-url" placeholder="https://example.com">
            </div>
            
            <div class="form-group">
                <label for="embed-color">Embed Color</label>
                <div class="color-picker">
                    <input type="color" id="embed-color" value="#5865f2">
                    <div class="color-picker-preview" id="color-preview" style="background-color: #5865f2;"></div>
                </div>
            </div>
            
            <div class="form-group">
                <label for="embed-timestamp">Timestamp</label>
                <select id="embed-timestamp">
                    <option value="none">No timestamp</option>
                    <option value="now" selected>Current time</option>
                    <option value="custom">Custom time</option>
                </select>
                <input type="datetime-local" id="embed-custom-timestamp" class="hidden" style="margin-top: 8px;">
            </div>
            
            <div class="form-group">
                <label for="embed-author-name">Author Name</label>
                <input type="text" id="embed-author-name" placeholder="Author name">
            </div>
            
            <div class="flex-row">
                <div class="form-group">
                    <label for="embed-author-url">Author URL</label>
                    <input type="text" id="embed-author-url" placeholder="https://example.com">
                </div>
                <div class="form-group">
                    <label for="embed-author-icon">Author Icon URL</label>
                    <input type="text" id="embed-author-icon" placeholder="https://example.com/icon.png">
                </div>
            </div>
            
            <div class="form-group">
                <label for="embed-footer-text">Footer Text</label>
                <input type="text" id="embed-footer-text" placeholder="Footer text">
            </div>
            
            <div class="form-group">
                <label for="embed-footer-icon">Footer Icon URL</label>
                <input type="text" id="embed-footer-icon" placeholder="https://example.com/icon.png">
            </div>
            
            <div class="form-group">
                <label for="embed-image">Image URL</label>
                <input type="text" id="embed-image" placeholder="https://example.com/image.png">
            </div>
            
            <div class="form-group">
                <label for="embed-thumbnail">Thumbnail URL</label>
                <input type="text" id="embed-thumbnail" placeholder="https://example.com/thumbnail.png">
            </div>
            
            <h3>Embed Fields</h3>
            <div id="embed-fields-container">
                <!-- Fields will be added here -->
            </div>
            <button type="button" class="add-btn" id="add-field-btn">
                <span>+ Add Field</span>
            </button>
        </div>
        
        <div class="tab-content" id="advanced-tab">
            <div class="checkbox-group">
                <input type="checkbox" id="wait" checked>
                <label for="wait">Wait for message delivery (required for editing)</label>
            </div>
            
            <div class="checkbox-group">
                <input type="checkbox" id="thread-id">
                <label for="thread-id">Send to thread</label>
                <input type="text" id="thread-id-value" placeholder="Thread ID" class="hidden" style="margin-top: 8px;">
            </div>
            
            <div class="form-group">
                <label for="payload-json">Raw JSON Payload (overrides all other settings)</label>
                <textarea id="payload-json" placeholder='{"content": "Hello, world!"}'></textarea>
            </div>

            <h3>JSON Payload Preview</h3>
            <div class="json-preview-container">
                <button class="copy-json-btn" id="copy-json-btn">Copy JSON</button>
                <div class="json-preview" id="json-preview">
                    {"content":"Your JSON payload will appear here"}
                </div>
            </div>

            <div class="message-info" id="message-info" style="display: none;">
                <h3>Message Information</h3>
                <p><strong>Message ID:</strong> <span id="message-id"></span></p>
                <p><strong>Channel ID:</strong> <span id="channel-id"></span></p>
                <p><strong>Sent at:</strong> <span id="sent-time"></span></p>
            </div>
        </div>
        
        <div class="flex-row" style="margin-top: 24px;">
            <button class="btn btn-primary" id="send-btn">Send Webhook</button>
            <button class="btn btn-secondary" id="edit-btn" disabled>Edit Message</button>
            <button class="btn btn-danger" id="reset-btn">Reset Form</button>
        </div>
        
        <div class="status" id="status"></div>
    </div>
    
    <div class="panel">
        <h1>Message Preview</h1>
        <div class="discord-preview" id="discord-preview">
            <div class="discord-message">
                <div class="discord-avatar">D</div>
                <div class="discord-message-content">
                    <div class="discord-message-header">
                        <span class="discord-username">Discord Webhook</span>
                        <span class="discord-bot-tag">BOT</span>
                        <span class="discord-timestamp">Today at 12:00 PM</span>
                    </div>
                    <div class="discord-message-text" id="preview-content">
                        Your message will appear here.
                    </div>
                    <div id="preview-embed"></div>
                    <div id="preview-file"></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Store message information for editing
        let currentMessage = null;
        let fieldCount = 0;

        document.addEventListener('DOMContentLoaded', function() {
            // Tab switching
            const tabs = document.querySelectorAll('.tab');
            tabs.forEach(tab => {
                tab.addEventListener('click', function() {
                    // Remove active class from all tabs and content
                    document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                    document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
                    
                    // Add active class to clicked tab and corresponding content
                    this.classList.add('active');
                    const tabId = this.getAttribute('data-tab');
                    document.getElementById(`${tabId}-tab`).classList.add('active');
                    
                    // Update previews when switching tabs
                    updatePreview();
                    updateJsonPreview();
                });
            });
            
            // Color picker preview
            const colorPicker = document.getElementById('embed-color');
            const colorPreview = document.getElementById('color-preview');
            colorPicker.addEventListener('input', function() {
                colorPreview.style.backgroundColor = this.value;
                updatePreview();
                updateJsonPreview();
            });
            
            // Timestamp toggle
            const timestampSelect = document.getElementById('embed-timestamp');
            const customTimestamp = document.getElementById('embed-custom-timestamp');
            timestampSelect.addEventListener('change', function() {
                if (this.value === 'custom') {
                    customTimestamp.classList.remove('hidden');
                } else {
                    customTimestamp.classList.add('hidden');
                }
                updatePreview();
                updateJsonPreview();
            });
            
            // Custom timestamp input
            customTimestamp.addEventListener('input', function() {
                updatePreview();
                updateJsonPreview();
            });
            
            // Thread ID toggle
            const threadIdCheckbox = document.getElementById('thread-id');
            const threadIdValue = document.getElementById('thread-id-value');
            threadIdCheckbox.addEventListener('change', function() {
                if (this.checked) {
                    threadIdValue.classList.remove('hidden');
                } else {
                    threadIdValue.classList.add('hidden');
                }
                updateJsonPreview();
            });
            
            // Thread ID input
            threadIdValue.addEventListener('input', function() {
                updateJsonPreview();
            });
            
            // File upload preview
            const fileInput = document.getElementById('file');
            const filePreview = document.getElementById('file-preview');
            fileInput.addEventListener('change', function() {
                if (this.files && this.files[0]) {
                    const file = this.files[0];
                    filePreview.textContent = `File: ${file.name} (${formatFileSize(file.size)})`;
                    
                    if (file.type.startsWith('image/')) {
                        const reader = new FileReader();
                        reader.onload = function(e) {
                            filePreview.innerHTML = `File: ${file.name} (${formatFileSize(file.size)})<br><img src="${e.target.result}" alt="Preview">`;
                            updatePreview();
                        };
                        reader.readAsDataURL(file);
                    }
                    
                    updatePreview();
                    updateJsonPreview();
                } else {
                    filePreview.textContent = '';
                    updatePreview();
                    updateJsonPreview();
                }
            });
            
            // Add embed field
            const addFieldBtn = document.getElementById('add-field-btn');
            const fieldsContainer = document.getElementById('embed-fields-container');
            
            addFieldBtn.addEventListener('click', function() {
                addEmbedField('', '', false);
            });
            
            // Avatar URL input with preview
            const avatarUrlInput = document.getElementById('avatar-url');
            avatarUrlInput.addEventListener('input', function() {
                updateAvatarPreview(this.value);
                updatePreview();
                updateJsonPreview();
            });
            
            // User ID lookup
            document.getElementById('fetch-user-btn').addEventListener('click', fetchUserProfile);
            document.getElementById('user-id-input').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') fetchUserProfile();
            });
            
            // JSON input sync with form
            document.getElementById('payload-json').addEventListener('input', function() {
                try {
                    const json = JSON.parse(this.value);
                    updateFormFromJson(json);
                    updatePreview();
                } catch (e) {
                    // Don't update if JSON is invalid
                }
            });
            
            // Input events for preview updates
            const previewInputs = [
                'webhook-url', 'username', 'avatar-url', 'content', 'embed-title', 'embed-description',
                'embed-url', 'embed-author-name', 'embed-author-url', 'embed-author-icon',
                'embed-footer-text', 'embed-footer-icon', 'embed-image', 'embed-thumbnail'
            ];
            
            previewInputs.forEach(id => {
                document.getElementById(id).addEventListener('input', function() {
                    updatePreview();
                    updateJsonPreview();
                });
            });
            
            // Checkbox events
            document.getElementById('tts').addEventListener('change', function() {
                updatePreview();
                updateJsonPreview();
            });
            
            document.getElementById('wait').addEventListener('change', updateJsonPreview);
            
            // Copy JSON button
            document.getElementById('copy-json-btn').addEventListener('click', function() {
                const jsonText = document.getElementById('json-preview').textContent;
                navigator.clipboard.writeText(jsonText).then(() => {
                    const originalText = this.textContent;
                    this.textContent = 'Copied!';
                    setTimeout(() => {
                        this.textContent = originalText;
                    }, 2000);
                });
            });
            
            // Reset form
            document.getElementById('reset-btn').addEventListener('click', function() {
                if (confirm('Are you sure you want to reset the form?')) {
                    document.querySelector('form').reset();
                    fieldsContainer.innerHTML = '';
                    filePreview.innerHTML = '';
                    fieldCount = 0;
                    updatePreview();
                    updateJsonPreview();
                    document.getElementById('status').classList.remove('success', 'error');
                    document.getElementById('status').textContent = '';
                    document.getElementById('message-info').style.display = 'none';
                    document.getElementById('edit-btn').disabled = true;
                    currentMessage = null;
                    document.getElementById('avatar-preview').style.display = 'none';
                    document.getElementById('avatar-loading').style.display = 'none';
                    document.getElementById('avatar-preview-text').textContent = 'No avatar selected';
                }
            });
            
            // Send webhook
            document.getElementById('send-btn').addEventListener('click', sendWebhook);
            
            // Edit message
            document.getElementById('edit-btn').addEventListener('click', editMessage);
            
            // Initial updates
            updatePreview();
            updateJsonPreview();
        });
        
        function addEmbedField(name, value, inline) {
            const fieldId = `field-${fieldCount++}`;
            const fieldsContainer = document.getElementById('embed-fields-container');
            const fieldHtml = `
                <div class="field-array-item" id="${fieldId}">
                    <button class="remove-btn" data-field="${fieldId}">Ã—</button>
                    <div class="form-group">
                        <label for="${fieldId}-name">Field Name</label>
                        <input type="text" id="${fieldId}-name" placeholder="Field name" class="field-name" value="${name || ''}">
                    </div>
                    <div class="form-group">
                        <label for="${fieldId}-value">Field Value</label>
                        <textarea id="${fieldId}-value" placeholder="Field value (supports markdown)" class="field-value">${value || ''}</textarea>
                    </div>
                    <div class="checkbox-group">
                        <input type="checkbox" id="${fieldId}-inline" class="field-inline" ${inline ? 'checked' : ''}>
                        <label for="${fieldId}-inline">Inline</label>
                    </div>
                </div>
            `;
            fieldsContainer.insertAdjacentHTML('beforeend', fieldHtml);
            
            // Add event listeners to new fields
            document.querySelectorAll(`#${fieldId} .field-name, #${fieldId} .field-value, #${fieldId} .field-inline`).forEach(el => {
                el.addEventListener('input', function() {
                    updatePreview();
                    updateJsonPreview();
                });
            });
            
            // Add remove button functionality
            document.querySelector(`[data-field="${fieldId}"]`).addEventListener('click', function() {
                document.getElementById(fieldId).remove();
                updatePreview();
                updateJsonPreview();
            });
            
            updatePreview();
            updateJsonPreview();
        }
        
        function updatePreview() {
            // Update message content preview
            const content = document.getElementById('content').value;
            const contentPreview = document.getElementById('preview-content');
            contentPreview.innerHTML = content || '<em>No message content</em>';
            
            // Update username preview
            const username = document.getElementById('username').value;
            const usernamePreview = document.querySelector('.discord-username');
            usernamePreview.textContent = username || 'Discord Webhook';
            
            // Update avatar preview
            const avatarUrl = document.getElementById('avatar-url').value;
            const avatarPreview = document.querySelector('.discord-avatar');
            if (avatarUrl) {
                avatarPreview.textContent = '';
                avatarPreview.style.backgroundImage = `url('${avatarUrl}')`;
                avatarPreview.style.backgroundSize = 'cover';
            } else {
                avatarPreview.style.backgroundImage = 'none';
                avatarPreview.textContent = username ? username.charAt(0).toUpperCase() : 'D';
                avatarPreview.style.backgroundColor = '#5865f2';
            }
            
            // Update embed preview
            const embedPreview = document.getElementById('preview-embed');
            embedPreview.innerHTML = '';
            
            const embedTitle = document.getElementById('embed-title').value;
            const embedDescription = document.getElementById('embed-description').value;
            const embedUrl = document.getElementById('embed-url').value;
            const embedColor = document.getElementById('embed-color').value;
            const embedAuthorName = document.getElementById('embed-author-name').value;
            const embedAuthorUrl = document.getElementById('embed-author-url').value;
            const embedAuthorIcon = document.getElementById('embed-author-icon').value;
            const embedFooterText = document.getElementById('embed-footer-text').value;
            const embedFooterIcon = document.getElementById('embed-footer-icon').value;
            const embedImage = document.getElementById('embed-image').value;
            const embedThumbnail = document.getElementById('embed-thumbnail').value;
            
            const hasEmbed = embedTitle || embedDescription || embedAuthorName || embedFooterText || 
                           document.querySelector('.field-array-item');
            
            if (hasEmbed) {
                const embedHtml = `
                    <div class="discord-embed">
                        <div class="discord-embed-color" style="background-color: ${embedColor || '#5865f2'}"></div>
                        <div class="discord-embed-content">
                            ${embedAuthorName || embedAuthorIcon ? `
                                <div class="discord-embed-header">
                                    ${embedAuthorIcon ? `<img src="${embedAuthorIcon}" class="discord-embed-footer-icon">` : ''}
                                    ${embedAuthorName ? `
                                        <span class="discord-embed-author">
                                            ${embedAuthorUrl ? `<a href="${embedAuthorUrl}">${embedAuthorName}</a>` : embedAuthorName}
                                        </span>
                                    ` : ''}
                                </div>
                            ` : ''}
                            
                            ${embedTitle ? `
                                <div class="discord-embed-title">
                                    ${embedUrl ? `<a href="${embedUrl}">${embedTitle}</a>` : embedTitle}
                                </div>
                            ` : ''}
                            
                            ${embedDescription ? `
                                <div class="discord-embed-description">${embedDescription}</div>
                            ` : ''}
                            
                            ${getEmbedFieldsHtml()}
                            
                            ${embedImage ? `
                                <img src="${embedImage}" class="discord-embed-image">
                            ` : ''}
                            
                            ${embedFooterText || embedFooterIcon ? `
                                <div class="discord-embed-footer">
                                    ${embedFooterIcon ? `<img src="${embedFooterIcon}" class="discord-embed-footer-icon">` : ''}
                                    ${embedFooterText ? `<span>${embedFooterText}</span>` : ''}
                                </div>
                            ` : ''}
                        </div>
                        
                        ${embedThumbnail ? `
                            <img src="${embedThumbnail}" class="discord-embed-thumbnail">
                        ` : ''}
                    </div>
                `;
                
                embedPreview.innerHTML = embedHtml;
            }
            
            // Update file preview
            const filePreview = document.getElementById('preview-file');
            filePreview.innerHTML = '';
            
            const fileInput = document.getElementById('file');
            if (fileInput.files && fileInput.files[0]) {
                const file = fileInput.files[0];
                if (file.type.startsWith('image/')) {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        filePreview.innerHTML = `
                            <div style="margin-top: 16px;">
                                <div style="font-size: 14px; color: var(--discord-text-muted); margin-bottom: 4px;">Attachment</div>
                                <img src="${e.target.result}" style="max-width: 100%; border-radius: 4px;">
                            </div>
                        `;
                    };
                    reader.readAsDataURL(file);
                } else {
                    filePreview.innerHTML = `
                        <div style="margin-top: 16px;">
                            <div style="font-size: 14px; color: var(--discord-text-muted); margin-bottom: 4px;">Attachment</div>
                            <div style="background: var(--discord-darker); padding: 8px; border-radius: 4px;">
                                ${file.name} (${formatFileSize(file.size)})
                            </div>
                        </div>
                    `;
                }
            }
        }
        
        function getEmbedFieldsHtml() {
            const fields = document.querySelectorAll('.field-array-item');
            if (fields.length === 0) return '';
            
            let fieldsHtml = '<div class="discord-embed-fields">';
            
            fields.forEach(field => {
                const name = field.querySelector('.field-name').value;
                const value = field.querySelector('.field-value').value;
                const isInline = field.querySelector('.field-inline').checked;
                
                if (name || value) {
                    fieldsHtml += `
                        <div class="discord-embed-field ${isInline ? 'inline' : 'full'}">
                            ${name ? `<div class="discord-embed-field-title">${name}</div>` : ''}
                            ${value ? `<div class="discord-embed-field-value">${value}</div>` : ''}
                        </div>
                    `;
                }
            });
            
            fieldsHtml += '</div>';
            return fieldsHtml;
        }
        
        function updateJsonPreview() {
            const payload = buildPayload();
            const jsonPreview = document.getElementById('json-preview');
            
            // Format the JSON with syntax highlighting
            const formattedJson = syntaxHighlight(JSON.stringify(payload, null, 2));
            jsonPreview.innerHTML = formattedJson;
        }
        
        function syntaxHighlight(json) {
            if (!json) return '';
            
            json = json.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
            return json.replace(
                /("(\\u[a-zA-Z0-9]{4}|\\[^u]|[^\\"])*"(\s*:)?|\b(true|false|null)\b|-?\d+(?:\.\d*)?(?:[eE][+\-]?\d+)?)/g,
                function (match) {
                    let cls = 'json-number';
                    if (/^"/.test(match)) {
                        if (/:$/.test(match)) {
                            cls = 'json-key';
                        } else {
                            cls = 'json-string';
                        }
                    } else if (/true|false/.test(match)) {
                        cls = 'json-boolean';
                    } else if (/null/.test(match)) {
                        cls = 'json-null';
                    }
                    return '<span class="' + cls + '">' + match + '</span>';
                }
            );
        }
        
        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }
        
        function updateAvatarPreview(url) {
            const avatarPreview = document.getElementById('avatar-preview');
            const avatarPreviewText = document.getElementById('avatar-preview-text');
            const avatarLoading = document.getElementById('avatar-loading');
            
            if (url && url.trim() !== '') {
                avatarPreview.src = url;
                avatarPreview.onload = function() {
                    avatarPreview.style.display = 'block';
                    avatarPreviewText.textContent = '';
                    avatarLoading.style.display = 'none';
                };
                avatarPreview.onerror = function() {
                    avatarPreview.style.display = 'none';
                    avatarPreviewText.textContent = 'Invalid image URL';
                    avatarLoading.style.display = 'none';
                };
                avatarPreview.style.display = 'none';
                avatarPreviewText.textContent = 'Loading...';
                avatarLoading.style.display = 'flex';
            } else {
                avatarPreview.style.display = 'none';
                avatarLoading.style.display = 'none';
                avatarPreviewText.textContent = 'No avatar selected';
            }
        }
        
        async function fetchUserProfile() {
            const userId = document.getElementById('user-id-input').value.trim();
            if (!userId) return;
            
            const statusElement = document.getElementById('status');
            statusElement.classList.remove('success', 'error');
            statusElement.textContent = 'Fetching user profile...';
            
            try {
                // Using a CORS proxy to access Discord's API
                const proxyUrl = 'https://api.allorigins.win/raw?url=';
                const discordApiUrl = `https://discord.com/api/v9/users/${userId}`;
                
                const response = await fetch(proxyUrl + encodeURIComponent(discordApiUrl), {
                    headers: {
                        'Accept': 'application/json'
                    }
                });
                
                if (response.ok) {
                    const user = await response.json();
                    
                    // Update username and avatar
                    document.getElementById('username').value = user.username;
                    document.getElementById('avatar-url').value = user.avatar 
                        ? `https://cdn.discordapp.com/avatars/${user.id}/${user.avatar}.png?size=256`
                        : `https://cdn.discordapp.com/embed/avatars/${user.discriminator % 5}.png`;
                    updateAvatarPreview(document.getElementById('avatar-url').value);
                    
                    statusElement.textContent = `Fetched profile for ${user.username}#${user.discriminator}`;
                    statusElement.className = 'status success';
                    
                    updatePreview();
                    updateJsonPreview();
                } else {
                    const errorData = await response.json();
                    throw new Error(errorData.message || 'User not found');
                }
            } catch (error) {
                statusElement.textContent = `Error: ${error.message}`;
                statusElement.className = 'status error';
                console.error('Error fetching user:', error);
            }
        }
        
        function updateFormFromJson(json) {
            try {
                // Basic fields
                if (json.content !== undefined) document.getElementById('content').value = json.content;
                if (json.username !== undefined) document.getElementById('username').value = json.username;
                if (json.avatar_url !== undefined) {
                    document.getElementById('avatar-url').value = json.avatar_url;
                    updateAvatarPreview(json.avatar_url);
                }
                if (json.tts !== undefined) document.getElementById('tts').checked = json.tts;
                
                // Handle embeds if they exist
                if (json.embeds && json.embeds.length > 0) {
                    const embed = json.embeds[0];
                    
                    // Embed basic fields
                    if (embed.title !== undefined) document.getElementById('embed-title').value = embed.title;
                    if (embed.description !== undefined) document.getElementById('embed-description').value = embed.description;
                    if (embed.url !== undefined) document.getElementById('embed-url').value = embed.url;
                    
                    // Embed color
                    if (embed.color !== undefined) {
                        const hexColor = `#${embed.color.toString(16).padStart(6, '0')}`;
                        document.getElementById('embed-color').value = hexColor;
                        document.getElementById('color-preview').style.backgroundColor = hexColor;
                    }
                    
                    // Timestamp
                    if (embed.timestamp !== undefined) {
                        document.getElementById('embed-timestamp').value = 'custom';
                        document.getElementById('embed-custom-timestamp').classList.remove('hidden');
                        const date = new Date(embed.timestamp);
                        const formattedDate = date.toISOString().slice(0, 16);
                        document.getElementById('embed-custom-timestamp').value = formattedDate;
                    } else {
                        document.getElementById('embed-timestamp').value = 'none';
                        document.getElementById('embed-custom-timestamp').classList.add('hidden');
                    }
                    
                    // Author
                    if (embed.author) {
                        if (embed.author.name !== undefined) document.getElementById('embed-author-name').value = embed.author.name;
                        if (embed.author.url !== undefined) document.getElementById('embed-author-url').value = embed.author.url;
                        if (embed.author.icon_url !== undefined) document.getElementById('embed-author-icon').value = embed.author.icon_url;
                    } else {
                        document.getElementById('embed-author-name').value = '';
                        document.getElementById('embed-author-url').value = '';
                        document.getElementById('embed-author-icon').value = '';
                    }
                    
                    // Footer
                    if (embed.footer) {
                        if (embed.footer.text !== undefined) document.getElementById('embed-footer-text').value = embed.footer.text;
                        if (embed.footer.icon_url !== undefined) document.getElementById('embed-footer-icon').value = embed.footer.icon_url;
                    } else {
                        document.getElementById('embed-footer-text').value = '';
                        document.getElementById('embed-footer-icon').value = '';
                    }
                    
                    // Image and thumbnail
                    if (embed.image && embed.image.url !== undefined) {
                        document.getElementById('embed-image').value = embed.image.url;
                    } else {
                        document.getElementById('embed-image').value = '';
                    }
                    
                    if (embed.thumbnail && embed.thumbnail.url !== undefined) {
                        document.getElementById('embed-thumbnail').value = embed.thumbnail.url;
                    } else {
                        document.getElementById('embed-thumbnail').value = '';
                    }
                    
                    // Fields
                    if (embed.fields && embed.fields.length > 0) {
                        // Clear existing fields
                        document.getElementById('embed-fields-container').innerHTML = '';
                        fieldCount = 0;
                        
                        // Add new fields from JSON
                        embed.fields.forEach(field => {
                            addEmbedField(field.name, field.value, field.inline);
                        });
                    } else {
                        // Clear fields if none in JSON
                        document.getElementById('embed-fields-container').innerHTML = '';
                        fieldCount = 0;
                    }
                } else {
                    // Clear embed fields if no embeds in JSON
                    document.getElementById('embed-title').value = '';
                    document.getElementById('embed-description').value = '';
                    document.getElementById('embed-url').value = '';
                    document.getElementById('embed-author-name').value = '';
                    document.getElementById('embed-author-url').value = '';
                    document.getElementById('embed-author-icon').value = '';
                    document.getElementById('embed-footer-text').value = '';
                    document.getElementById('embed-footer-icon').value = '';
                    document.getElementById('embed-image').value = '';
                    document.getElementById('embed-thumbnail').value = '';
                    document.getElementById('embed-fields-container').innerHTML = '';
                    fieldCount = 0;
                }
            } catch (e) {
                console.error('Error updating form from JSON:', e);
            }
        }
        
        async function sendWebhook() {
            const webhookUrl = document.getElementById('webhook-url').value;
            if (!webhookUrl) {
                showStatus('Please enter a webhook URL', 'error');
                return;
            }
            
            const payload = buildPayload();
            const statusElement = document.getElementById('status');
            statusElement.classList.remove('success', 'error');
            statusElement.textContent = 'Sending...';
            
            // Disable buttons during send
            document.getElementById('send-btn').disabled = true;
            document.getElementById('edit-btn').disabled = true;
            document.getElementById('reset-btn').disabled = true;
            
            try {
                const formData = new FormData();
                const fileInput = document.getElementById('file');
                
                if (fileInput.files && fileInput.files[0]) {
                    formData.append('file', fileInput.files[0]);
                }

                // Add JSON payload if not using raw JSON
                if (!document.getElementById('payload-json').value) {
                    formData.append('payload_json', JSON.stringify(payload));
                } else {
                    try {
                        const jsonPayload = JSON.parse(document.getElementById('payload-json').value);
                        formData.append('payload_json', JSON.stringify(jsonPayload));
                    } catch (e) {
                        showStatus('Invalid JSON payload', 'error');
                        return;
                    }
                }

                // Build final URL with parameters
                let finalUrl = webhookUrl;
                const params = new URLSearchParams();
                
                if (document.getElementById('thread-id').checked) {
                    const threadId = document.getElementById('thread-id-value').value;
                    if (threadId) {
                        params.append('thread_id', threadId);
                    }
                }
                
                // Always wait for response when sending (needed for message ID)
                params.append('wait', 'true');
                
                // Add parameters to URL if any exist
                if (params.toString()) {
                    finalUrl += (finalUrl.includes('?') ? '&' : '?') + params.toString();
                }

                const response = await fetch(finalUrl, {
                    method: 'POST',
                    body: formData
                });

                if (response.ok) {
                    try {
                        const result = await response.json();
                        showStatus('Webhook sent successfully!', 'success');
                        console.log('Webhook response:', result);
                        
                        // Store message information for editing
                        currentMessage = {
                            id: result.id,
                            channel_id: result.channel_id,
                            webhookUrl: webhookUrl,
                            threadId: document.getElementById('thread-id').checked ? 
                                     document.getElementById('thread-id-value').value : null
                        };
                        
                        // Update message info panel
                        document.getElementById('message-id').textContent = result.id;
                        document.getElementById('channel-id').textContent = result.channel_id;
                        document.getElementById('sent-time').textContent = new Date(result.timestamp).toLocaleString();
                        document.getElementById('message-info').style.display = 'block';
                        
                        // Enable edit button
                        document.getElementById('edit-btn').disabled = false;
                    } catch (e) {
                        showStatus('Webhook sent but failed to parse response', 'error');
                    }
                } else {
                    // Try to get error message, fall back to status text
                    let errorText;
                    try {
                        const errorResponse = await response.json();
                        errorText = errorResponse.message || JSON.stringify(errorResponse);
                    } catch {
                        errorText = await response.text() || response.statusText;
                    }
                    showStatus(`Error: ${response.status} - ${errorText}`, 'error');
                    console.error('Webhook error:', errorText);
                }
            } catch (error) {
                showStatus(`Network Error: ${error.message}`, 'error');
                console.error('Webhook error:', error);
            } finally {
                // Re-enable buttons
                document.getElementById('send-btn').disabled = false;
                document.getElementById('reset-btn').disabled = false;
            }
        }
        
        async function editMessage() {
            if (!currentMessage) {
                showStatus('No message to edit - send a message first', 'error');
                return;
            }

            const payload = buildPayload();
            const statusElement = document.getElementById('status');
            statusElement.classList.remove('success', 'error');
            statusElement.textContent = 'Editing...';
            
            // Disable buttons during edit
            document.getElementById('send-btn').disabled = true;
            document.getElementById('edit-btn').disabled = true;
            document.getElementById('reset-btn').disabled = true;

            try {
                // Build the edit URL
                let editUrl = `${currentMessage.webhookUrl}/messages/${currentMessage.id}`;
                
                if (currentMessage.threadId) {
                    editUrl += `?thread_id=${currentMessage.threadId}`;
                }

                const response = await fetch(editUrl, {
                    method: 'PATCH',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(payload)
                });

                if (response.ok) {
                    const result = await response.json();
                    showStatus('Message edited successfully!', 'success');
                    console.log('Edit response:', result);
                    
                    // Update message info panel with new timestamp
                    document.getElementById('sent-time').textContent = new Date(result.edited_timestamp || result.timestamp).toLocaleString();
                } else {
                    // Try to get error message, fall back to status text
                    let errorText;
                    try {
                        const errorResponse = await response.json();
                        errorText = errorResponse.message || JSON.stringify(errorResponse);
                    } catch {
                        errorText = await response.text() || response.statusText;
                    }
                    showStatus(`Error: ${response.status} - ${errorText}`, 'error');
                    console.error('Edit error:', errorText);
                }
            } catch (error) {
                showStatus(`Network Error: ${error.message}`, 'error');
                console.error('Edit error:', error);
            } finally {
                // Re-enable buttons
                document.getElementById('send-btn').disabled = false;
                document.getElementById('edit-btn').disabled = false;
                document.getElementById('reset-btn').disabled = false;
            }
        }
        
        function buildPayload() {
            // If raw JSON is provided, use that
            const rawJson = document.getElementById('payload-json').value;
            if (rawJson) {
                try {
                    return JSON.parse(rawJson);
                } catch (e) {
                    return { error: "Invalid JSON" };
                }
            }
            
            const payload = {};
            
            // Basic message properties
            const content = document.getElementById('content').value;
            if (content) payload.content = content;
            
            const username = document.getElementById('username').value;
            if (username) payload.username = username;
            
            const avatarUrl = document.getElementById('avatar-url').value;
            if (avatarUrl) payload.avatar_url = avatarUrl;
            
            if (document.getElementById('tts').checked) {
                payload.tts = true;
            }
            
            // Embed properties
            const embedTitle = document.getElementById('embed-title').value;
            const embedDescription = document.getElementById('embed-description').value;
            const embedUrl = document.getElementById('embed-url').value;
            const embedColor = document.getElementById('embed-color').value;
            const embedAuthorName = document.getElementById('embed-author-name').value;
            const embedAuthorUrl = document.getElementById('embed-author-url').value;
            const embedAuthorIcon = document.getElementById('embed-author-icon').value;
            const embedFooterText = document.getElementById('embed-footer-text').value;
            const embedFooterIcon = document.getElementById('embed-footer-icon').value;
            const embedImage = document.getElementById('embed-image').value;
            const embedThumbnail = document.getElementById('embed-thumbnail').value;
            
            const hasEmbed = embedTitle || embedDescription || embedAuthorName || embedFooterText || 
                           document.querySelector('.field-array-item');
            
            if (hasEmbed) {
                payload.embeds = [{}];
                const embed = payload.embeds[0];
                
                if (embedTitle) embed.title = embedTitle;
                if (embedDescription) embed.description = embedDescription;
                if (embedUrl) embed.url = embedUrl;
                
                // Convert hex color to decimal
                if (embedColor && embedColor !== '#5865f2') {
                    embed.color = parseInt(embedColor.substring(1), 16);
                }
                
                // Timestamp
                const timestampSelect = document.getElementById('embed-timestamp').value;
                if (timestampSelect === 'now') {
                    embed.timestamp = new Date().toISOString();
                } else if (timestampSelect === 'custom') {
                    const customTimestamp = document.getElementById('embed-custom-timestamp').value;
                    if (customTimestamp) {
                        embed.timestamp = new Date(customTimestamp).toISOString();
                    }
                }
                
                // Author
                if (embedAuthorName || embedAuthorIcon) {
                    embed.author = {};
                    if (embedAuthorName) embed.author.name = embedAuthorName;
                    if (embedAuthorUrl) embed.author.url = embedAuthorUrl;
                    if (embedAuthorIcon) embed.author.icon_url = embedAuthorIcon;
                }
                
                // Footer
                if (embedFooterText || embedFooterIcon) {
                    embed.footer = {};
                    if (embedFooterText) embed.footer.text = embedFooterText;
                    if (embedFooterIcon) embed.footer.icon_url = embedFooterIcon;
                }
                
                // Image
                if (embedImage) {
                    embed.image = { url: embedImage };
                }
                
                // Thumbnail
                if (embedThumbnail) {
                    embed.thumbnail = { url: embedThumbnail };
                }
                
                // Fields
                const fields = document.querySelectorAll('.field-array-item');
                if (fields.length > 0) {
                    embed.fields = [];
                    
                    fields.forEach(field => {
                        const name = field.querySelector('.field-name').value;
                        const value = field.querySelector('.field-value').value;
                        const isInline = field.querySelector('.field-inline').checked;
                        
                        if (name || value) {
                            embed.fields.push({
                                name: name || '\u200b', // Zero-width space if empty
                                value: value || '\u200b',
                                inline: isInline
                            });
                        }
                    });
                }
            }
            
            return payload;
        }
        
        function showStatus(message, type) {
            const statusElement = document.getElementById('status');
            statusElement.textContent = message;
            statusElement.className = 'status ' + type;
        }
    </script>
</body>
</html>
